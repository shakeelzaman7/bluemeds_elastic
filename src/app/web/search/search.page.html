<div class="p-5" vexContainer>
  <app-breadcrumbs [directionList]="directionList"></app-breadcrumbs>
</div>
<ion-grid class="rounded-lg shadow-8 bg-card h-full p-5 sm:p-10 mb-6" vexContainer>
  <ion-row class="h-full ion-align-items-center ion-justify-content-center">
    <ion-col>
      <br>
      <div class="text-center">
        <h2>
          <ion-text class="text-[#2A51A3] text-3xl">Buscar medicamentos</ion-text>
        </h2>
        <p>
          <ion-text color="medium" class="text-base">Busca tu medicamento por nombre, marca o principio activo.</ion-text>
        </p>
      </div>
      <br>
      
      <form [formGroup]="searchForm">
        <div class="py-4" fxLayout="column">
          <div fxLayout="row" fxLayout.lt-sm="column" fxLayoutGap="16px" fxLayoutGap.lt-sm="0">
            <div class="search-input-container rounded-full px-5 border border-solid border-[#2A51A3] border-1 relative" 
                 fxFlex="auto" fxFlex.lt-md="auto" fxLayout="row" fxLayoutAlign="end center">
              <ic-icon [icIcon]="icSearch" size="23px" class="mr-1 text-[#2A51A3]" (click)="focusSearchInput()" 
                      #tooltipMessage="matTooltip" 
                      matTooltip="Escribe en la barra de búsqueda al menos 4 letras para buscar por nombre, marca o principio activo">
              </ic-icon>
              
              <input #searchInput [formControl]="searchCtrl" class="py-3 text-[#2A51A3] outline-none w-full bg-[#E8F5FF]"
                    placeholder="Escribe al menos 4 letras para buscar..." type="search">
              
              <ion-icon *ngIf="searchCtrl.value !== null && searchCtrl.value !== ''" 
                        name="close-circle" class="text-2xl text-[#2A51A3] cursor-pointer" 
                        (click)="resetSearch()">
              </ion-icon>
              
              <div class="ml-2 cursor-pointer" (click)="toggleFilters()">
                <ic-icon [icIcon]="icFilter" size="23px" class="text-[#2A51A3]"></ic-icon>
              </div>
            </div>
          </div>
          
          <div *ngIf="showSuggestions && suggestionsList.length > 0" 
               class="suggestions-container w-full bg-white mt-1 rounded-lg shadow-lg border border-gray-200 absolute z-50">
            <div *ngFor="let suggestion of suggestionsList; trackBy: trackSuggestions" 
                class="p-3 border-b border-gray-100 hover:bg-blue-50 cursor-pointer"
                (click)="selectSuggestion(suggestion)">
              <div class="font-medium">{{ suggestion.name }}</div>
              <div *ngIf="suggestion.ingredient" class="text-sm text-gray-600">{{ suggestion.ingredient }}</div>
              <div *ngIf="suggestion.laboratory" class="text-xs text-gray-500">{{ suggestion.laboratory }}</div>
            </div>
          </div>
          
          <div *ngIf="showFilters" class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200 animate-fade-in">
            <div class="flex justify-between items-center mb-3">
              <h3 class="text-[#2A51A3] text-lg font-semibold">Filtros de búsqueda</h3>
              <ion-icon name="close" class="text-[#2A51A3] cursor-pointer" (click)="toggleFilters()"></ion-icon>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Laboratorio</label>
                <select formControlName="laboratory" class="w-full p-2 border border-gray-300 rounded-md">
                  <option value="">Todos los laboratorios</option>
                  <option *ngFor="let lab of laboratories" [value]="lab">{{ lab }}</option>
                </select>
              </div>
              
              <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Área terapéutica</label>
                <select formControlName="therapeuticArea" class="w-full p-2 border border-gray-300 rounded-md">
                  <option value="">Todas las áreas</option>
                  <option *ngFor="let area of therapeuticAreas" [value]="area">{{ area }}</option>
                </select>
              </div>
              
              <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Ordenar por</label>
                <select formControlName="sortBy" class="w-full p-2 border border-gray-300 rounded-md">
                  <option *ngFor="let option of sortOptions" [value]="option.value">{{ option.label }}</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </form>
      
      <div *ngIf="searchError" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative my-4">
        <strong class="font-bold">Error:</strong>
        <span class="block sm:inline">{{ searchError }}</span>
      </div>
      
      <div *ngIf="isSearching" class="text-center my-4">
        <ion-spinner name="crescent" class="text-[#2A51A3]"></ion-spinner>
        <p class="mt-2 text-[#2A51A3]">Buscando medicamentos...</p>
      </div>
      
      <!-- Regular table component for search results -->
      <app-resource-table 
        *ngIf="searchResults && searchResults.length > 0 && !isSearching"
        (onRowClick)="publicationSelected($event)" 
        (onButtonClick)="publicationSelected($event)"
        rcp="search" 
        [rcpParams]="searchParams" 
        [showHeader]="true" 
        [displaceTop]="false" 
        [type]="resourceType" 
        [items]="items"
        [columnsDefinitions]="columns" 
        title="Resultados ({{ searchResults?.length || 0 }})" 
        #table>
      </app-resource-table>
      
      <!-- No results message with form -->
      <div *ngIf="searchResults?.length == 0 && searchCtrl.value && searchCtrl.value.length >= 4 && !isSearching" 
           class="text-center flex flex-col items-center my-2 card px-5 py-10">
        <img class="w-[100px]" src="assets/icons/not-found-medicament.png" alt="Medicament not found">
        <h4 class="font-bold text-[#198CC2] text-xl mt-2">Lo sentimos,</h4>
        <p class="text-xl mb-1 py-2 text-[#198CC2]">ese medicamento no se encuentra disponible en estos momentos</p>
        <span class="text-[#2C2C2C] text-md">Llena el siguiente formulario para solicitar que agreguemos tu medicamento a Bluemeds</span><br>
        <button (click)="showResultsForm()" class="text-md text-white rounded-full bg-[#3B5FAA] mt-2 py-3 px-16">
          Solicitar medicamento
        </button>
        <div *ngIf="results">
          <app-form-results (onResetSearchParams)="resetSearch()" [searchParams]="searchParams.key"></app-form-results>
        </div>
      </div>
    </ion-col>
  </ion-row>
</ion-grid>

<div *ngIf="!(layoutService.isMobile$ | async)" class="mt-5 mb-2 flex justify-center" >
  <ion-button routerLink="/web/search" class="font-bold h-10 mr-5 mb-5 needHelpOption" shape="round" (click)="openWindowsWhatsApp()">
    ¿Necesitas ayuda?
  </ion-button>
</div>

<div class="py-2" *ngIf="(layoutService.isMobile$ | async)" style="position:fixed;bottom:0;width:100%;background:transparent; z-index: 900 !important;">
  <div class="text-center">
    <ion-button routerLink="/web/search" class="normal-case font-bold text-lg h-10 needHelpOption" shape="round" size="default" (click)="openWindowsWhatsApp()">
      ¿Necesitas ayuda?
    </ion-button>
  </div>
</div>

<style>
  .animate-fade-in {
    animation: fadeIn 0.3s ease-in-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .suggestions-container {
    max-height: 300px;
    overflow-y: auto;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1000;
  }
</style>